import streamlit as st
import pandas as pd
import re, io

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡∏ñ‡∏≤‡∏ß‡∏£
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•", layout="wide", initial_sidebar_state="collapsed")

# ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏à‡∏≥‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô)
if 'fs' not in st.session_state: st.session_state.fs = {}
if 'sl' not in st.session_state: st.session_state.sl = ""

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) ---
c1, c2 = st.columns([1, 6])
with c1:
    st.image("https://cdn-icons-png.flaticon.com/512/3135/3135715.png", width=100)
with c2:
    st.title("üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô")
    st.write("üë®‚Äçüè´ **‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• ‡∏ö‡∏∏‡∏ç‡∏ä‡∏¥‡∏ï** | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ")

st.markdown("---")

# --- ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô) ---
# ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter accept_multiple_files=True
up = st.file_uploader("üì• ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Padlet (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)", type=["csv", "xlsx"], accept_multiple_files=True)

if up:
    for f in up: 
        st.session_state.fs[f.name] = f.getvalue()
    if not st.session_state.sl and len(up) > 0:
        st.session_state.sl = up[0].name

# ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏™‡∏•‡∏±‡∏ö‡∏î‡∏π
if st.session_state.fs:
    st.write("üìÇ **‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•):**")
    file_list = list(st.session_state.fs.keys())
    # ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏ñ‡∏ß‡∏•‡∏∞ 6 ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    cols = st.columns(6)
    for i, name in enumerate(file_list):
        if cols[i % 6].button(f"üìÑ {name[:12]}...", key=name, use_container_width=True):
            st.session_state.sl = name
            st.rerun()

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Pivot Table ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ---
def get_sorted_pv(df_sub, index_cols):
    pv = df_sub.drop_duplicates(index_cols + ['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°']).pivot(
        index=index_cols, columns='‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', values='‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
    ).fillna('-').reset_index()
    
    # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (1.1, 1.2, 1.10)
    acts = [c for c in pv.columns if c not in index_cols]
    acts.sort(key=lambda x: float(x) if re.match(r'^\d+\.?\d*$', x) else 999)
    
    # ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏î‡∏¢‡∏ô‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ‚úì
    pv['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°'] = (pv[acts] == '‚úì').sum(axis=1)
    return pv[index_cols + acts + ['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°']].sort_values('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà')

# --- ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
if st.session_state.sl:
    fn = st.session_state.sl
    raw = st.session_state.fs[fn]
    try:
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        df = pd.read_csv(io.BytesIO(raw)) if fn.endswith('.csv') else pd.read_excel(io.BytesIO(raw))
        df.columns = df.columns.astype(str).str.strip()
        
        res = []
        for _, r in df.iterrows():
            t = f"{r.get('‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á','')} {r.get('‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤','')} {r.get('‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô','')}"
            no = re.search(r'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà\s*(\d+)', t)
            ac = re.search(r'‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà\s*(\d+\.?\d*)', t)
            nm = re.search(r'(‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏î\.‡∏ä\.|‡∏î\.‡∏ç\.|‡∏î‡∏ä\.|‡∏î‡∏ç\.|‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á)\s*([^\s\d]+)\s+([^\s\d]+)', t)
            
            res.append({
                '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà': int(no.group(1)) if no else 999,
                '‡∏ä‡∏∑‡πà‡∏≠': nm.group(2) if nm else "-", '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': nm.group(3) if nm else "-",
                '‡∏Å‡∏•‡∏∏‡πà‡∏°': str(r.get('‡∏™‡πà‡∏ß‡∏ô','')).replace('‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà','').strip(),
                '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°': ac.group(1) if ac else None, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': '‚úì', 'raw': t[:30]+"..."
            })
        
        df_r = pd.DataFrame(res).dropna(subset=['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'])
        st.info(f"üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: **{fn}**")

        # 1. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        df_v = df_r[(df_r['‡∏ä‡∏∑‡πà‡∏≠'] != "-") & (df_r['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] != "-")]
        if not df_v.empty:
            st.subheader("‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)")
            st.dataframe(get_sorted_pv(df_v, ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà','‡∏ä‡∏∑‡πà‡∏≠','‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•','‡∏Å‡∏•‡∏∏‡πà‡∏°']), use_container_width=True)

        # 2. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á)
        df_inv = df_r[(df_r['‡∏ä‡∏∑‡πà‡∏≠'] == "-") | (df_r['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] == "-")]
        if not df_inv.empty:
            st.markdown("---")
            st.subheader("‚ö†Ô∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ)")
            st.dataframe(get_sorted_pv(df_inv, ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà','‡∏Å‡∏•‡∏∏‡πà‡∏°','raw']), use_container_width=True)

    except Exception as e: 
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå {fn}: {e}")
