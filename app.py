import streamlit as st
import pandas as pd
import re
import io

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô", layout="wide")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: Layout ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ---
head_col1, head_col2 = st.columns([1, 5])

with head_col1:
    # ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Icon ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡∏ö Static
    st.image("https://cdn-icons-png.flaticon.com/512/3135/3135715.png", width=140)

with head_col2:
    st.title("‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô")
    st.subheader("‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ")
    st.write("‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏• ‡∏ö‡∏∏‡∏ç‡∏ä‡∏¥‡∏ï")

st.markdown("---")

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°) ---
def process_data_logic(uploaded_file):
    try:
        raw_bytes = uploaded_file.getvalue()
        if uploaded_file.name.endswith('.csv'):
            df = pd.read_csv(io.BytesIO(raw_bytes), encoding='utf-8-sig')
        else:
            df = pd.read_excel(io.BytesIO(raw_bytes))
        
        df.columns = [str(c).strip() for c in df.columns]
        if '‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô' in df.columns:
            df = df[~df['‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô'].str.contains("‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•", na=False)]
            
        temp_results = []
        for _, row in df.iterrows():
            txt = f"{row.get('‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', '')} {row.get('‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', '')} {row.get('‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', '')}"
            
            # ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            st_no_match = re.search(r'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà\s*(\d+)', txt)
            st_no = st_no_match.group(1) if st_no_match else "999"
            
            # ‡∏™‡∏Å‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            nm_match = re.search(r'(‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏î\.‡∏ä\.|‡∏î\.‡∏ç\.|‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á)\s*([^\s\d]+)\s+([^\s\d]+)', txt)
            if nm_match:
                fname, lname = nm_match.group(2), nm_match.group(3)
            else:
                raw_name = str(row.get('‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')).split('(')[0].strip()
                prefixes = [r'^‡∏ô‡∏≤‡∏¢', r'^‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', r'^‡∏î\.‡∏ä\.', r'^‡∏î\.‡∏ç\.', r'^‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢', r'^‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á', r'^‡∏î‡∏ä\.', r'^‡∏î‡∏ç\.']
                for p in prefixes: raw_name = re.sub(p, '', raw_name).strip()
                parts = raw_name.split(maxsplit=1)
                fname = parts[0] if len(parts) > 0 else "-"
                lname = parts[1] if len(parts) > 1 else "-"
            
            # ‡∏™‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
            sec_txt = str(row.get('‡∏™‡πà‡∏ß‡∏ô', ''))
            g_num = re.search(r'(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà\s*\d+)', sec_txt)
            g_name = re.search(r'\)\s*(.*)', sec_txt)
            group_display = f"{g_num.group(1) if g_num else ''} {g_name.group(1).strip() if g_name else sec_txt}".strip()
            
            # ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
            act_match = re.search(r'‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà\s*(\d+\.?\d*)', txt)
            
            temp_results.append({
                '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà': int(st_no) if st_no.isdigit() else 999,
                '‡∏ä‡∏∑‡πà‡∏≠': fname, 
                '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': lname,
                '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°': group_display,
                '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°': act_match.group(1) if act_match else None,
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': '‚úì'
            })
        return pd.DataFrame(temp_results)
    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
        return None

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á Session State) ---
uploaded_file = st.file_uploader("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Padlet", type=["csv", "xlsx", "xls"])

if uploaded_file:
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
    st.success(f"üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: {uploaded_file.name}")
    
    df_res = process_data_logic(uploaded_file)
    
    if df_res is not None:
        # 1. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
        df_act = df_res[df_res['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'].notna()].copy()
        if not df_act.empty:
            st.subheader(f"üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
            pivot = df_act.drop_duplicates(subset=['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°']).pivot(
                index=['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°'], 
                columns='‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 
                values='‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
            ).fillna('-').reset_index()
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á (1, 2, 3...)
            pivot = pivot.sort_values(by=['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏ä‡∏∑‡πà‡∏≠'])
            st.dataframe(pivot, use_container_width=True)
            
            # ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            output = io.BytesIO()
            with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                pivot.to_excel(writer, index=False)
            st.download_button(label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏£‡∏∏‡∏õ (Excel)", data=output.getvalue(), file_name="Summary.xlsx")

        # 2. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏ô‡∏•‡∏∑‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        df_no_act = df_res[df_res['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'].isna()].copy()
        if not df_no_act.empty:
            st.markdown("---")
            st.warning("‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°")
            st.table(df_no_act[['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°']].sort_values('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'))
