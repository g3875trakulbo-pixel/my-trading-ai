import streamlit as st
import cv2
import numpy as np
from PIL import Image
import pytesseract # ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="Trading AI - Smart Scale", layout="centered")

st.title("üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏Å‡∏é 6 ‡∏Ç‡πâ‡∏≠ (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏Å‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)")

def analyze_with_scale(image):
    img_array = np.array(image.convert('RGB'))
    img_bgr = cv2.cvtColor(img_array, cv2.COLOR_RGB2BGR)
    h, w, _ = img_bgr.shape
    
    # --- 1. ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Right Scale Zone) ---
    # ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10-15% ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û
    right_scale_zone = img_bgr[:, int(w*0.85):w]
    gray_scale = cv2.cvtColor(right_scale_zone, cv2.COLOR_BGR2GRAY)
    
    # ‡πÉ‡∏ä‡πâ OCR ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
    # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Tesseract OCR ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á/Server ‡∏î‡πâ‡∏ß‡∏¢
    
    # --- 2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ó‡πà‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏ö‡∏ô‡πÅ‡∏Å‡∏ô ---
    # ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á Volume ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    vol_zone = img_bgr[int(h*0.8):int(h*0.95), int(w*0.7):int(w*0.85)]
    vol_gray = cv2.cvtColor(vol_zone, cv2.COLOR_BGR2GRAY)
    _, thresh = cv2.threshold(vol_gray, 50, 255, cv2.THRESH_BINARY)
    
    # ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Y-coordinate) ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á
    coords = np.column_stack(np.where(thresh > 0))
    if len(coords) > 0:
        highest_point = np.min(coords[:, 0]) # ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô
        vol_height_pct = 100 - (highest_point / vol_zone.shape[0] * 100)
    else:
        vol_height_pct = 0

    # --- 3. ‡∏Å‡∏é 1-4 (MACD) ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏é 6 (‡πÄ‡∏™‡πâ‡∏ô) ---
    # (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô)
    # ... (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡∏£‡∏ß‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Code ‡πÄ‡∏ï‡πá‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö)
    
    return int(vol_height_pct)

# ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
uploaded_file = st.file_uploader("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Å‡∏£‡∏≤‡∏ü (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)...", type=["jpg", "png", "jpeg"])

if uploaded_file:
    img = Image.open(uploaded_file)
    st.image(img, use_container_width=True)
    
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...'):
        score = analyze_with_scale(img)
        st.write(f"### üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ó‡πà‡∏á‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤: {score}%")
        st.progress(score / 100)
        
        if score > 70:
            st.success("‡πÅ‡∏ó‡πà‡∏á‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å: ‡πÅ‡∏£‡∏á‡∏™‡πà‡∏á‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 5")
        elif score > 30:
            st.warning("‡πÅ‡∏ó‡πà‡∏á‡∏¢‡∏≤‡∏ß‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á: ‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏™‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥")
        else:
            st.error("‡πÅ‡∏ó‡πà‡∏á‡∏™‡∏±‡πâ‡∏ô: ‡πÅ‡∏£‡∏á‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢")
