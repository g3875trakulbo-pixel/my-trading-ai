import streamlit as st
import cv2
import numpy as np
from PIL import Image

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="‡∏Å‡∏é 5 ‡∏Ç‡πâ‡∏≠ - ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü", layout="centered")

st.title("üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ó‡πà‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
st.write("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: ‡∏™‡∏µ, ‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á, ‡∏™‡∏±‡πâ‡∏ô/‡∏¢‡∏≤‡∏ß")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û (Core Logic)
def analyze_rules(image):
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å PIL ‡πÄ‡∏õ‡πá‡∏ô OpenCV format
    img_array = np.array(image.convert('RGB'))
    img_bgr = cv2.cvtColor(img_array, cv2.COLOR_RGB2BGR)
    h, w, _ = img_bgr.shape

    # --- 1. ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Crop Zones) ---
    # ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ‡πÅ‡∏ó‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (MACD) ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á 60-80%, ‡πÅ‡∏ó‡πà‡∏á‡∏•‡πà‡∏≤‡∏á (Volume) ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á 80-95%
    macd_zone = img_bgr[int(h*0.6):int(h*0.8), int(w*0.8):w]
    vol_zone = img_bgr[int(h*0.8):int(h*0.95), int(w*0.8):w]

    # --- 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏™/‡∏ó‡∏∂‡∏ö) ---
    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô HSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
    hsv_macd = cv2.cvtColor(macd_zone, cv2.COLOR_BGR2HSV)
    
    # ‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏î‡∏á
    lower_green = np.array([40, 40, 40])
    upper_green = np.array([80, 255, 255])
    lower_red = np.array([0, 40, 40])
    upper_red = np.array([10, 255, 255])

    mask_g = cv2.inRange(hsv_macd, lower_green, upper_green)
    mask_r = cv2.inRange(hsv_macd, lower_red, upper_red)

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏µ (‡πÉ‡∏™ = ‡∏°‡∏µ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß/‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞, ‡∏ó‡∏∂‡∏ö = ‡∏™‡∏µ‡πÄ‡∏ï‡πá‡∏°)
    is_green = np.sum(mask_g) > np.sum(mask_r)
    density = np.mean(mask_g if is_green else mask_r)
    is_clear = density < 150  # ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≠‡∏¢ = ‡πÉ‡∏™

    # --- 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß (Volume) ---
    vol_gray = cv2.cvtColor(vol_zone, cv2.COLOR_BGR2GRAY)
    _, thresh_vol = cv2.threshold(vol_gray, 50, 255, cv2.THRESH_BINARY)
    vol_height = np.sum(thresh_vol > 0)
    is_long = vol_height > 1000 # ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•

    # --- ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    res_color = ""
    res_dir = ""
    res_size = "‡∏¢‡∏≤‡∏ß" if is_long else "‡∏™‡∏±‡πâ‡∏ô"

    if is_green:
        if is_clear: # ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 1: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÉ‡∏™
            res_color, res_dir = "‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", "‡∏Ç‡∏∂‡πâ‡∏ô"
        else: # ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 2: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏∂‡∏ö
            res_color, res_dir = "‡∏™‡∏µ‡πÅ‡∏î‡∏á", "‡∏•‡∏á"
    else:
        if is_clear: # ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 3: ‡πÅ‡∏î‡∏á‡πÉ‡∏™
            res_color, res_dir = "‡∏™‡∏µ‡πÅ‡∏î‡∏á", "‡∏•‡∏á"
        else: # ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 4: ‡πÅ‡∏î‡∏á‡∏ó‡∏∂‡∏ö
            res_color, res_dir = "‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", "‡∏Ç‡∏∂‡πâ‡∏ô"

    return f"{res_color}, {res_dir}, {res_size}"

# ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
uploaded_file = st.file_uploader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û...", type=["jpg", "png", "jpeg"])

if uploaded_file is not None:
    image = Image.open(uploaded_file)
    st.image(image, caption='‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', use_container_width=True)
    
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...'):
        try:
            result = analyze_rules(image)
            st.markdown("---")
            st.subheader("‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏ó‡πà‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠:")
            st.header(f"üëâ {result}")
        except Exception as e:
            st.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô")

st.markdown("---")
st.caption("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ")
